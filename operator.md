## AWS Managed RabbitMQ

AWS Managed RabbitMQ is a managed message broker service provided by Amazon Web Services. It allows you to set up and operate RabbitMQ message brokers in the cloud, handling the provisioning, scaling, and managing of the RabbitMQ infrastructure.

### Design Decisions

1. **Deployment Mode**: The module supports both `SINGLE_INSTANCE` and `CLUSTER` deployment modes. For single instance deployments, ensure a solitary subnet is used.
2. **Encryption**: The service utilizes AWS KMS for encryption, with the capability to use custom AWS managed keys.
3. **Security**: A security group is created to control ingress traffic. Only traffic from within the VPC is allowed.
4. **Logging**: General logging can be enabled or disabled via a flag. Audit logging is conditional based on the userâ€™s settings.
5. **IAM Policy**: IAM policy is set to allow the necessary access for encrypting and decrypting messages within the broker.
6. **Alarms and Monitoring**: The module integrates with AWS CloudWatch for alarming on key metrics such as CPU utilization.

### Runbook

#### Common Issue: Unable to Connect to RabbitMQ Broker

If you're having trouble connecting to your RabbitMQ broker, check the security group settings to ensure that traffic is allowed from your network.

```sh
aws ec2 describe-security-groups --group-ids <RabbitMQ-Security-Group-ID>
```
This command checks the inbound rules for the specific security group. Ensure that the port 5671 (or your configured RabbitMQ port) is open for the necessary IP ranges.

#### Common Issue: RabbitMQ Broker Not Starting

If the RabbitMQ broker fails to start or crashes, check the CloudWatch logs for detailed error information.

```sh
aws logs describe-log-streams --log-group-name /aws/amazonmq/broker-name
aws logs get-log-events --log-group-name /aws/amazonmq/broker-name --log-stream-name <Log-Stream-Name>
```
These commands retrieve logs for the broker instance to help diagnose the issue. 

#### Common Issue: High CPU Utilization

If you receive alerts about high CPU utilization from CloudWatch, you can take the following steps to investigate and resolve the issue. 

1. **CloudWatch Metrics**:
   ```sh
   aws cloudwatch get-metric-statistics --namespace AWS/AmazonMQ --metric-name SystemCpuUtilization --dimensions Name=Broker,Value=<broker-name> --start-time <start-time> --end-time <end-time> --period 300 --statistics Average
   ```

    Review the metrics over a period to identify if the high CPU utilization is constant or intermittent.

2. **RabbitMQ Diagnostics**:
   Access the RabbitMQ management interface to get more detailed insights on queues, connections, channels, and more.

```sh
# Replace with your RabbitMQ management interface URL
curl -u username:password http://<hostname>:<port>/api/overview
```

This will give you an overview and potentially highlight areas that need attention such as high message rates, numerous open channels, or long-running connections.

#### Common Issue: Encryption/Decryption Failures

If you experience issues related to encryption or decryption, check the KMS policy and ensure it's correctly set up to authorize the MQ service.

```sh
aws kms get-key-policy --key-id <KMS-Key-ID> --policy-name default
```

Verify the policy output to ensure it includes permissions for `mq.amazonaws.com` to perform necessary actions.

If the above doesn't resolve the issue, validate the KMS key's status:
```sh
aws kms describe-key --key-id <KMS-Key-ID>
```

Ensure that the key is enabled and in a usable state.

#### Common Issue: Password Issues

If there are password issues, such as authentication failures:

1. Reset the RabbitMQ user password:
    ```sh
    # Run Terraform apply to regenerate the password
    terraform apply -var 'reset_password=true'
    ```

2. Update your application with the new password generated by the random password resource.

